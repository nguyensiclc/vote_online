import{o as C,c as t,a as c,F as V,r as B,t as h,d as p,e as n,f as s,n as I,w as j,g as M}from"./index-DPEeJoVm.js";import{a as _}from"./api-DbpbKoG9.js";const F={class:"card"},S={key:0,class:"loading"},N={key:1},x={key:0,class:"candidates"},D=["value","disabled"],E={class:"candidate-label"},K={key:1,class:"loading"},O={class:"actions"},P=["disabled"],T={key:0},U={key:1},z={key:0,class:"helper"},A={key:1,class:"helper"},H={key:2,class:"message message-success"},J={key:3,class:"message message-error"},G={__name:"App",setup(L){const v=n([]),l=n(null),g=n(!1),d=n(!1),m=n(!1),o=n(0),r=n(""),i=n("");async function y(){g.value=!0,i.value="";try{const e=await fetch(_("/api/vote/candidates"));if(!e.ok)throw new Error("Failed to load candidates");const a=await e.json();v.value=a}catch(e){console.error(e),i.value="Không thể tải danh sách tiết mục. Vui lòng tải lại trang hoặc thử lại sau."}finally{g.value=!1}}async function b(){try{const e=await fetch(_("/api/vote/my-vote"));if(e.status===204){m.value=!1;return}if(!e.ok)return;const a=await e.json();a&&a.candidateId!=null&&(l.value=a.candidateId,m.value=!0,r.value="Bạn đã từng bình chọn. Bạn có thể đổi lựa chọn và bấm Bình chọn lại.")}catch(e){console.error("Failed to load current vote",e)}}async function f(){if(!(!l.value||d.value)){d.value=!0,r.value="",i.value="";try{const e=await fetch(_("/api/vote"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({candidateId:l.value})});if(e.ok){const a=await e.json().catch(()=>({}));r.value=a.message||"Cảm ơn bạn! Phiếu bình chọn của bạn đã được ghi nhận.",m.value=!0,k()}else{const a=await e.json().catch(()=>({}));i.value=a.message||"Không thể gửi bình chọn. Vui lòng thử lại sau."}}catch(e){console.error(e),i.value="Có lỗi mạng khi gửi bình chọn. Vui lòng thử lại."}finally{d.value=!1}}}function k(){o.value=10;const e=setInterval(()=>{o.value<=1?(o.value=0,clearInterval(e)):o.value-=1},1e3)}return C(()=>{y(),b()}),(e,a)=>(s(),t("main",F,[a[1]||(a[1]=c("header",{class:"card-header"},[c("h1",{class:"card-title"},"Bình chọn tiết mục văn nghệ yêu thích"),c("p",{class:"card-subtitle"}," Vui lòng chọn một tiết mục và bấm nút bình chọn. ")],-1)),g.value?(s(),t("section",S," Đang tải danh sách tiết mục... ")):(s(),t("section",N,[v.value.length?(s(),t("div",x,[(s(!0),t(V,null,B(v.value,u=>(s(),t("label",{key:u.id,class:I(["candidate-option",{selected:l.value===u.id}])},[j(c("input",{class:"radio",type:"radio",name:"candidate",value:u.id,"onUpdate:modelValue":a[0]||(a[0]=w=>l.value=w),disabled:d.value},null,8,D),[[M,l.value]]),c("span",E,h(u.name),1)],2))),128))])):(s(),t("p",K," Hiện chưa có tiết mục nào để bình chọn. ")),c("div",O,[c("button",{class:"btn btn-primary",disabled:!l.value||d.value||o.value>0,onClick:f},[d.value?(s(),t("span",U,"Đang gửi...")):(s(),t("span",T,"Bình chọn"))],8,P),o.value<=0?(s(),t("p",z," Mỗi thiết bị / mạng chỉ có một phiếu hợp lệ, nhưng bạn có thể thay đổi lựa chọn sau một khoảng thời gian. ")):(s(),t("p",A," Bạn vừa bình chọn, vui lòng đợi "+h(o.value)+" giây trước khi đổi lựa chọn. ",1))]),r.value?(s(),t("div",H,h(r.value),1)):p("",!0),i.value?(s(),t("div",J,h(i.value),1)):p("",!0)]))]))}};export{G as default};
