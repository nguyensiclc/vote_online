import{o as j,c as a,a as e,n as g,F,r as M,w as A,v as x,b as N,t as r,d as f,e as s,f as o}from"./index-DPEeJoVm.js";import{a as w}from"./api-DbpbKoG9.js";const $={class:"card"},z={key:0,class:"loading"},B={key:1},D={class:"admin-tabs",style:{"justify-content":"space-between","align-items":"center"}},I={style:{display:"flex",gap:"0.5rem"}},P={class:"admin-tabs"},L={key:0},O={key:0,class:"results-table"},U={key:1,class:"loading"},E={key:1},Q={class:"form-row"},H={class:"form-row"},J=["disabled"],R={key:0},G={key:1},W={key:0,class:"message message-success",style:{"margin-top":"0.75rem"}},X={key:1,class:"message message-error",style:{"margin-top":"0.75rem"}},et={__name:"AdminApp",setup(Y){const b=s(!1),y=s([]),d=s(""),C=s(0),v=s(!1),i=s("results"),c=s(""),m=s(""),h=s(!1),p=s(""),u=s("");function k(){const n=localStorage.getItem("adminAuth")||"";return n?"Basic "+n:""}async function T(){b.value=!0,d.value="";try{const n=await fetch(w("/api/admin/results"),{headers:{Authorization:k()}});if(!n.ok){n.status===401||n.status===403?(d.value="Sai tài khoản hoặc mật khẩu admin.",v.value=!1):d.value="Không thể tải kết quả bình chọn. Vui lòng thử lại sau.";return}const t=await n.json();y.value=t,C.value=t.reduce((l,_)=>l+(_.totalVotes??0),0),v.value=!0}catch(n){console.error(n),d.value="Có lỗi mạng khi tải kết quả. Vui lòng thử lại."}finally{b.value=!1}}function V(){localStorage.removeItem("adminAuth"),window.location.href="/"}function S(n,t){return!t||t===0?"0%":`${(n/t*100).toFixed(1)}%`}async function q(){try{const n=await fetch(w("/api/admin/poll-config"),{headers:{Authorization:k()}});if(!n.ok)return;const t=await n.json();c.value=t.title??"",m.value=(t.options??[]).join(`
`)}catch(n){console.error("Failed to load poll config",n)}}async function K(){p.value="",u.value="",h.value=!0;try{const n=m.value.split(`
`).map(l=>l.trim()).filter(l=>l.length>0);if(!c.value||n.length===0){u.value="Vui lòng nhập tiêu đề và ít nhất một option.",h.value=!1;return}if(!(await fetch(w("/api/admin/poll-config"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:k()},body:JSON.stringify({title:c.value,options:n})})).ok){u.value="Không thể lưu cấu hình chủ đề. Vui lòng thử lại.";return}p.value="Lưu cấu hình chủ đề thành công. Danh sách option và phiếu đã được làm mới.",await T()}catch(n){console.error("Failed to save poll config",n),u.value="Có lỗi khi lưu cấu hình chủ đề. Vui lòng thử lại."}finally{h.value=!1}}return j(()=>{if(!localStorage.getItem("adminAuth")){window.location.href="/";return}T().then(()=>{v.value?q():V()})}),(n,t)=>(o(),a("main",$,[t[10]||(t[10]=e("header",{class:"card-header"},[e("h1",{class:"card-title"},"Kết quả bình chọn văn nghệ (Admin)")],-1)),b.value?(o(),a("section",z," Đang tải kết quả bình chọn... ")):v.value?(o(),a("section",B,[e("div",D,[e("div",I,[e("button",{class:g(["tab-button",{active:i.value==="results"}]),onClick:t[0]||(t[0]=l=>i.value="results")}," Kết quả bình chọn ",2),e("button",{class:g(["tab-button",{active:i.value==="manage"}]),onClick:t[1]||(t[1]=l=>i.value="manage")}," Quản lý danh sách bình chọn ",2)]),e("button",{class:"tab-button",onClick:V}," Đăng xuất ")]),e("div",P,[e("button",{class:g(["tab-button",{active:i.value==="results"}]),onClick:t[2]||(t[2]=l=>i.value="results")}," Kết quả bình chọn ",2),e("button",{class:g(["tab-button",{active:i.value==="manage"}]),onClick:t[3]||(t[3]=l=>i.value="manage")}," Quản lý danh sách bình chọn ",2)]),i.value==="results"?(o(),a("section",L,[y.value.length?(o(),a("table",O,[t[6]||(t[6]=e("thead",null,[e("tr",null,[e("th",null,"STT"),e("th",null,"Tiết mục"),e("th",null,"Tổng số phiếu"),e("th",null,"Tỉ lệ (%)")])],-1)),e("tbody",null,[(o(!0),a(F,null,M(y.value,(l,_)=>(o(),a("tr",{key:l.candidateId},[e("td",null,r(_+1),1),e("td",null,r(l.candidateName),1),e("td",null,r(l.totalVotes),1),e("td",null,r(S(l.totalVotes,C.value)),1)]))),128))])])):(o(),a("p",U," Chưa có phiếu bình chọn nào. "))])):i.value==="manage"?(o(),a("section",E,[e("form",{class:"poll-config-form",onSubmit:N(K,["prevent"])},[e("div",Q,[t[7]||(t[7]=e("label",{for:"poll-title"},"Chủ đề bình chọn",-1)),A(e("input",{id:"poll-title","onUpdate:modelValue":t[4]||(t[4]=l=>c.value=l),type:"text",placeholder:"Nhập tiêu đề chủ đề bình chọn"},null,512),[[x,c.value]])]),e("div",H,[t[8]||(t[8]=e("label",{for:"poll-options"}," Danh sách option (mỗi dòng là một option) ",-1)),A(e("textarea",{id:"poll-options","onUpdate:modelValue":t[5]||(t[5]=l=>m.value=l),rows:"6",placeholder:`Ví dụ:\r
Tiết mục văn nghệ số 1\r
Tiết mục văn nghệ số 2\r
Tiết mục văn nghệ số 3`},null,512),[[x,m.value]])]),t[9]||(t[9]=e("p",{class:"helper"}," Khi lưu, hệ thống sẽ xóa toàn bộ phiếu hiện tại và tạo mới danh sách option theo nội dung bạn nhập. ",-1)),e("button",{class:"btn btn-primary",type:"submit",disabled:h.value},[h.value?(o(),a("span",G,"Đang lưu...")):(o(),a("span",R,"Lưu cấu hình chủ đề"))],8,J)],32),p.value?(o(),a("div",W,r(p.value),1)):f("",!0),u.value?(o(),a("div",X,r(u.value),1)):f("",!0)])):f("",!0)])):f("",!0)]))}};export{et as default};
